// システム設定初期化
g1=960 g2=540	// 画面サイズ
GSg1,g2;		// 画面サイズ設定
//SM1;			// BGM0番を再生
GW33;			// 速度ウエイト

// 画像描画(c1:x軸, c2:y軸, c3:画像番号)
// IN: @ポインタにキャラ構造体の先頭を入れておくこと
#0{
    x=@ y=@(1   // 座標を取得
    G@(2,x,y;		// 描画
}

// x,yを画面の範囲内に収める
#1{
	a=@ a<0 a[@=0]
	a=@ a+24 a>g1 a[@=g1 @-24]
	@>1
	a=@ a<0 a[@=0]
	a=@ a+32 a>g2 a[@=g2 @-32]
}

// #@版List
// IN:
#2{

}

// プレイヤーとの距離測定
// IN: @ポインタに測定対象のキャラ先頭
// OUT: r 目標までの距離
#3{
	x1=c1 y1=c2 x2=@ y2=@(1
	a1=CCx1-x2; a2=CCy1-y2;
	a1*a1 a2*a2 r=CCa1+a2;
	r=C_Qr;
}

// 距離に応じて音色を鳴らす
// IN: a 距離
#4{
	i=10
	[
		// 距離の値が大きいので、5000区切りで距離を測定
		b=i b*100 b=CCb<a; b[SSi; Si; i=1;]
	i-1 i]
}


// Player
@:c1
@=0 @(1=0 @(2=1 #0;

// Target
@:c4
@=240 @(1=180 @(2=2 #0;

c=2;
s1=4;
k1=0;	// k1=1:Left, 2:Right, 3:UP, 4:DOWN
z=1 [
    //GC;
	GA10; GC; GA100;	// 残像処理（処理速度が低下する）
    
	// キー判定
	f=0
	k=KLF; k[k1=1 f=1 u1=0]	// LEFT
	k=KRT; k[k1=2 f=1 u1=0]	// RIGHT
	k=KUP; k[k1=3 f=1 u1=0]	// UP
	k=KDW; k[k1=4 f=1 u1=0]	// DOWN
	
	f[		// キー入力判定
		u[	// 多重入力ロック機構(CT:1t)
			x=c1 y=c2

			b=CCk1==1; b[c1-80]
			b=CCk1==2; b[c1+80]
			b=CCk1==3; b[c2-60]
			b=CCk1==4; b[c2+60]
			@:c1 #1		// 画面の範囲内に収める
			u=0
			a=CR; a%3;
			b=0; b=CCb==a; b[s-2 Ss;]
			b=1; b=CCb==a; b[Ss;]
			b=2; b=CCb==a; b[s+2 Ss;]
		]
	]

	b=t b=CCt%15; b=CCb<1; b[
		k2=CR; k2%4;
		b=CCk2==0; b[c4-80 a=CR; a%2; a+3; Sa; s=a]
		b=CCk2==1; b[c4+80 a=CR; a%2; a+5; Sa; s=a]
		b=CCk2==2; b[c5-60 a=CR; a%2; a+7; Sa; s=a]
		b=CCk2==3; b[c5+60 a=CR; a%2; a+1; Sa; s=a]
		@:c4 #1
	]
	
	// @を設定し、関数で全キャラを描画
	i=1 l=0 l+c [
		@:c(i #0
		i+3
	l-1 l]

	// ソナー（スペース）
	k=KSp; k[SS4; @:c4; #3; a=r #4;]


	// マウスカーソルの座標を取得
	x=KMX; y=KMY; G116;
	// 終了キー（Esc）判定
	k=KEs; k[z=0]
	
	// 多重キー入力制御用（ロック解除）
	b=u1 b>1 b[ u=1 ]
	u1+1 b=u1 b>30 b[u1=0]


	
	@:c4 #3

	// タイムカウント
	GT300,20,t;
	GT300,40,t1;
	t+1 b=t b>31 b[
		t=1 t1+1
	]
	
	// デバッグ用テキスト
	GT500,30,"r="; GT530,30,r;
	
	GT500,60,"x="; GT530,60,c1;
	GT500,90,"y="; GT530,90,c2;
	
	GT500,120,"u="; GT530,120,u;


    // 画面出力（FLIP）
    GF;
z]